<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🤖 Voice Controlled Robot</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style-beautiful.css') }}">
</head>
<body>
  <div class="container">
    <header>
      <h1>🤖 Voice Controlled Robot</h1>
      <div id="connectionStatus" class="status disconnected">
        <span class="dot"></span>
        <span id="statusText">MEMUAT...</span>
      </div>
    </header>

    <p class="subtitle">Tekan dan tahan tombol mikrofon untuk memberikan perintah suara</p>

    <div class="main-content">
      <div class="mic-section">
        <button class="mic-btn" id="startButton">
          <i class="fas fa-microphone"></i>
          <div class="pulse-ring"></div>
        </button>
        <p id="micStatus" class="mic-status">Tekan dan tahan untuk merekam</p>
      </div>

      <div class="command-section">
        <div class="card">
          <h2><i class="fas fa-lightbulb"></i> Contoh Perintah</h2>
          <ul class="command-list">
            <li>💡 Nyalakan lampu</li>
            <li>🔌 Matikan lampu</li>
            <li>➡️ Ke kanan</li>
            <li>⬅️ Ke kiri</li>
            <li>⬆️ Maju</li>
            <li>⬇️ Mundur</li>
            <li>🛑 Berhenti</li>
            <li>🌡️ Cek suhu</li>
            <li>🔊 Nyalakan suara 1000 Hz</li>
            <li>🔇 Matikan suara</li>
            <li>🚨 Bunyikan alarm</li>
            <li>🎵 Mainkan musik</li>
            <li>🔔 Bunyikan bel</li>
          </ul>
        </div>

        <div class="card history-card">
          <h2><i class="fas fa-history"></i> Riwayat Perintah</h2>
          <div id="commandHistory" class="history-list">
            <!-- Command history will appear here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="notification" class="notification">
    <i class="fas fa-info-circle"></i>
    <span id="notificationText">Mendengarkan...</span>
  </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  <script>
    // DOM Elements
    const connectionStatus = document.getElementById('connectionStatus');
    const statusText = document.getElementById('statusText');
    const startButton = document.getElementById('startButton');
    const micStatus = document.getElementById('micStatus');
    const commandHistory = document.getElementById('commandHistory');
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notificationText');
    
    // Audio recording variables
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    
    // Initialize the application
    document.addEventListener('DOMContentLoaded', () => {
      // Check connection status
      checkConnection();
      
      // Set up event listeners
      setupEventListeners();
    });
    
    // Set up event listeners
    function setupEventListeners() {
      // Microphone button events
      startButton.addEventListener('mousedown', startRecording);
      startButton.addEventListener('mouseup', stopRecording);
      startButton.addEventListener('mouseleave', handleMouseLeave);
      
      // Also support touch events for mobile
      startButton.addEventListener('touchstart', (e) => {
        e.preventDefault();
        startRecording();
      });
      
      startButton.addEventListener('touchend', (e) => {
        e.preventDefault();
        stopRecording();
      });
    }
    
    // Check connection status
    async function checkConnection() {
      try {
        const response = await fetch('/api/check-connection');
        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        updateConnectionStatus(data.connected);
        
        // Schedule next check in 5 seconds if still on the page
        setTimeout(checkConnection, 5000);
      } catch (error) {
        console.error('Error checking connection:', error);
        updateConnectionStatus(false);
        
        // Retry after delay on error
        setTimeout(checkConnection, 10000);
      }
    }
    
    // Update connection status UI
    function updateConnectionStatus(isConnected) {
      if (isConnected) {
        connectionStatus.classList.remove('disconnected');
        connectionStatus.classList.add('connected');
        statusText.textContent = 'TERHUBUNG';
      } else {
        connectionStatus.classList.remove('connected');
        connectionStatus.classList.add('disconnected');
        statusText.textContent = 'TERPUTUS';
      }
    }
    
    // Start recording audio
    async function startRecording() {
      if (isRecording) return;
      
      try {
        if (!mediaRecorder) {
          await initMicrophone();
        }
        
        if (mediaRecorder && mediaRecorder.state === 'inactive') {
          audioChunks = [];
          mediaRecorder.start();
          isRecording = true;
          startButton.classList.add('recording');
          micStatus.textContent = 'Merekam...';
          showNotification('Mendengarkan...', 'info');
        }
      } catch (error) {
        console.error('Error starting recording:', error);
        showNotification('Gagal mengakses mikrofon', 'error');
      }
    }
    
    // Stop recording audio
    async function stopRecording() {
      if (!isRecording || !mediaRecorder || mediaRecorder.state === 'inactive') return;
      
      try {
        mediaRecorder.stop();
        isRecording = false;
        startButton.classList.remove('recording');
        micStatus.textContent = 'Memproses...';
        showNotification('Memproses perintah...', 'info');
      } catch (error) {
        console.error('Error stopping recording:', error);
        showNotification('Gagal menghentikan perekaman', 'error');
      }
    }
    
    // Handle mouse leaving while recording
    function handleMouseLeave(e) {
      if (e.buttons === 1) { // If primary button is pressed
        stopRecording();
      }
    }
    
    // Initialize microphone
    async function initMicrophone() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        
        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
          }
        };
        
        mediaRecorder.onstop = async () => {
          if (audioChunks.length > 0) {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            await sendAudioToServer(audioBlob);
          }
          audioChunks = [];
        };
        
        mediaRecorder.onerror = (event) => {
          console.error('MediaRecorder error:', event.error);
          showNotification('Kesalahan perekaman audio', 'error');
        };
        
        return true;
      } catch (error) {
        console.error('Error initializing microphone:', error);
        showNotification('Tidak dapat mengakses mikrofon', 'error');
        return false;
      }
    }
    
    // Send audio to server for processing
    async function sendAudioToServer(audioBlob) {
      const formData = new FormData();
      formData.append('audio', audioBlob, 'recording.wav');
      
      try {
        const response = await fetch('/process_audio', {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.status === 'success') {
          addToHistory(data.command || 'Perintah tidak dikenali', data.response || 'Tidak ada respon');
          showNotification('Perintah berhasil diproses', 'success');
        } else {
          showNotification(data.error || 'Gagal memproses perintah', 'error');
        }
        
        micStatus.textContent = 'Tekan dan tahan untuk merekam';
      } catch (error) {
        console.error('Error sending audio to server:', error);
        showNotification('Kesalahan koneksi', 'error');
        micStatus.textContent = 'Coba lagi';
      }
    }
    
    // Add command to history
    function addToHistory(command, response) {
      const historyItem = document.createElement('div');
      historyItem.className = 'history-item';
      historyItem.innerHTML = `
        <div class="history-command">${command}</div>
        <div class="history-response">${response}</div>
        <div class="history-time">${new Date().toLocaleTimeString()}</div>
      `;
      
      // Add to the top of the history
      if (commandHistory.firstChild) {
        commandHistory.insertBefore(historyItem, commandHistory.firstChild);
      } else {
        commandHistory.appendChild(historyItem);
      }
      
      // Limit history to 20 items
      if (commandHistory.children.length > 20) {
        commandHistory.removeChild(commandHistory.lastChild);
      }
    }
    
    // Show notification
    function showNotification(message, type = 'info') {
      notificationText.textContent = message;
      notification.className = `notification show ${type}`;
      
      // Auto-hide after 3 seconds
      clearTimeout(notification.timeout);
      notification.timeout = setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    </script>
</body>
</html>
